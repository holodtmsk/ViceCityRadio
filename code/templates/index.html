<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <div class="profile">
            <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∞–≤–∞—Ç–∞—Ä–µ -->
            <div class="avatar">{{ initial }}</div> <!-- –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ initial (–ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∏–º–µ–Ω–∏) -->
            <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="name">{{ username }}</div>
            <!-- –í—Å—Ç–∞–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏–Ω–æ–≤, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–æ–º -->
            <div class="balance">${{ balance }}</div>
            <div class="tickets">
                üéüÔ∏è {{ spins }}
            </div>
        </div>
        
        <div class="slot-game">
            <span class="slot-game-text">SLOT GAME</span>
            <img src="{{ url_for('static', filename='images/slot_machine.png') }}" alt="Slot Machine" class="icon">
            <button class="play-button">PLAY</button>
        </div>

        <div class="container">
            <button id="farming-button" class="start-button">Start Farming</button>
        </div>

        <div class="navigation-bar">
            <div class="nav-item">
                <img src="{{ url_for('static', filename='images/home_icon.png') }}" alt="Home" class="nav-icon">
                <span>Home</span>
            </div>
            <div class="nav-item">
                <img src="{{ url_for('static', filename='images/frens_icon.png') }}" alt="Frens" class="nav-icon">
                <span>Frens</span>
            </div>
            <div class="nav-item">
                <img src="{{ url_for('static', filename='images/wallet_icon.png') }}" alt="Wallet" class="nav-icon">
                <span>Wallet</span>
            </div>
        </div>

        <script>
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp API
            window.Telegram.WebApp.ready();

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const user = window.Telegram.WebApp.initDataUnsafe.user;
            if (user) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ GET-–∑–∞–ø—Ä–æ—Å
                fetch(`/get_user_data?username=${user.username}&first_name=${user.first_name}&last_name=${user.last_name}&id=${user.id}`, {
                    method: 'GET',
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('Method Not Allowed');
                    }
                    return response.json();
                }).then(data => {
                    console.log('User data received successfully:', data);
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å, —Å–ø–∏–Ω—ã –∏ –∏–Ω–∏—Ü–∏–∞–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞
                    document.querySelector('.balance').textContent = `$${data.balance}`;
                    document.querySelector('.tickets').textContent = `üéüÔ∏è ${data.spins}`;
                    document.querySelector('.avatar').textContent = data.initial;
                }).catch(error => {
                    console.error('Error fetching user data:', error);
                });
            }

            // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "Start Farming"
            document.addEventListener('DOMContentLoaded', function () {
                const farmingButton = document.getElementById('farming-button');
                let farmingInProgress = false;

                farmingButton.addEventListener('click', function () {
                    if (farmingInProgress || farmingButton.classList.contains('collect')) return;

                    // –ó–∞–ø—É—Å–∫ haptic feedback –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
                    if (window.Telegram && Telegram.WebApp.HapticFeedback) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('light'); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
                    }

                    farmingInProgress = true;
                    farmingButton.classList.add('farming');
                    farmingButton.innerHTML = 'üéü Farming goods... <span class="countdown">5</span>';

                    let timeLeft = 5;
                    const countdownInterval = setInterval(() => {
                        timeLeft--;
                        farmingButton.querySelector('.countdown').textContent = timeLeft;

                        if (timeLeft <= 0) {
                            clearInterval(countdownInterval);
                            farmingInProgress = false;
                            farmingButton.classList.remove('farming');
                            farmingButton.classList.add('collect');
                            farmingButton.textContent = 'Collect reward';

                            // Haptic feedback –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ñ–∞—Ä–º–∏–Ω–≥–∞
                            if (window.Telegram && Telegram.WebApp.HapticFeedback) {
                                Telegram.WebApp.HapticFeedback.impactOccurred('medium'); // –°—Ä–µ–¥–Ω—è—è –≤–∏–±—Ä–∞—Ü–∏—è
                            }
                        }
                    }, 1000);
                });

                farmingButton.addEventListener('click', function () {
                    if (!farmingButton.classList.contains('collect')) return;

                    // Haptic feedback –ø—Ä–∏ —Å–±–æ—Ä–µ –Ω–∞–≥—Ä–∞–¥—ã
                    if (window.Telegram && Telegram.WebApp.HapticFeedback) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('heavy'); // –°–∏–ª—å–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ POST-–∑–∞–ø—Ä–æ—Å
                    fetch('/collect_reward', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            username: user.username // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp
                        }),
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error('Method Not Allowed');
                        }
                        return response.json();
                    }).then(data => {
                        if (data.newBalance !== undefined && data.newSpins !== undefined) {
                            document.querySelector('.balance').textContent = `$${data.newBalance}`;
                            document.querySelector('.tickets').textContent = `üéüÔ∏è ${data.newSpins}`;
                        } else {
                            console.error('–î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã.');
                        }
                    }).catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞–≥—Ä–∞–¥—ã:', error);
                    });

                    farmingButton.classList.remove('collect');
                    farmingButton.textContent = 'Start Farming';
                });
            });
        </script>
    </div>
</body>
</html>
